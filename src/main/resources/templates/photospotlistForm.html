<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ì¶œì‚¬ì§€ ì‹ ì²­ ë‚´ì—­</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <!-- ì¹´ì¹´ì˜¤ë§µ SDK -->
    <script
            type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=dcc14e4ed8875f5829fe1274e43cee7b&libraries=services,drawing">
    </script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8fafc;
        }
        .map-container {
            height: 250px;
            width: 100%;
            display: none;
        }
    </style>
</head>
<body>

<div th:replace="layout/navbar :: fragment"></div>

<!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
<div class="max-w-6xl mx-auto p-6 bg-white shadow-lg rounded-lg mt-6">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">ğŸ“ ì¶œì‚¬ ì‹ ì²­ ëª©ë¡</h1>

    <!-- ì¶œì‚¬ ëª©ë¡ -->
    <div class="space-y-4">
        <div th:each="photoSpot : ${photoSpotList}" class="bg-white rounded-lg shadow-md p-5">
            <div class="flex justify-between items-center border-b pb-3">
                <h3 class="text-lg font-semibold">
                    <a th:href="@{/photospot/view/{id}(id=${photoSpot.id})}"
                       th:text="${photoSpot.title}"
                       class="text-blue-600 hover:underline">
                    </a>
                </h3>
                <span class="text-sm text-gray-500" th:text="${photoSpot.date}"></span>
            </div>
            <div class="mt-3 flex justify-between items-center">
                <span class="text-gray-700 font-medium" th:text="${photoSpot.userNickname}"></span>
            </div>

            <!-- ì§€ë„ í‘œì‹œ ë²„íŠ¼ -->
            <div class="mt-3 text-right">
                <!-- pathListJsonì„ data-pathì— ë°”ì¸ë”© -->
                <button th:attr="data-id=${photoSpot.id}, data-path=${photoSpot.pathListJson}"
                        onclick="toggleMap(this)"
                        class="px-3 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-md shadow-md">
                    ğŸŒ ì§€ë„ ë³´ê¸°
                </button>
            </div>

            <!-- ì§€ë„ ì»¨í…Œì´ë„ˆ -->
            <div th:id="'map-' + ${photoSpot.id}" class="map-container mt-3 rounded-lg shadow-md"></div>
        </div>
    </div>

    <!-- ì¶œì‚¬ì§€ ì‹ ì²­ ë²„íŠ¼ -->
    <div class="mt-6 text-right">
        <a href="/photospot"
           class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md shadow-md">
            âœï¸ ì¶œì‚¬ì§€ ì‹ ì²­
        </a>
    </div>

</div>

<script>
    let activeMaps = {}; // ìƒì„±ëœ ì§€ë„ ê°ì²´ë¥¼ ì €ì¥

    function toggleMap(button) {
        let id = button.getAttribute("data-id");
        let pathJson = button.getAttribute("data-path");
        let mapContainer = document.getElementById('map-' + id);

        if (mapContainer.style.display === "none") {
            mapContainer.style.display = "block";

            // ì´ë¯¸ ìƒì„±ëœ ì§€ë„ë¼ë©´ ìƒˆë¡œ ë§Œë“¤ì§€ ì•ŠìŒ
            if (!activeMaps[id]) {
                let mapOption = {
                    center: new kakao.maps.LatLng(37.566826, 126.9786567),
                    level: 5
                };

                let map = new kakao.maps.Map(mapContainer, mapOption);
                activeMaps[id] = map;

                // JSON ë°ì´í„° íŒŒì‹±
                let pathList = [];
                try {
                    pathList = JSON.parse(pathJson);
                } catch (e) {
                    console.error("Invalid JSON for pathList:", e);
                }

                if (pathList.length > 0) {
                    let bounds = new kakao.maps.LatLngBounds();
                    let linePath = [];

                    pathList.forEach(point => {
                        if (!point || typeof point.latitude !== "number" || typeof point.longitude !== "number") return;
                        let latLng = new kakao.maps.LatLng(point.latitude, point.longitude);
                        linePath.push(latLng);
                        bounds.extend(latLng);

                        new kakao.maps.Marker({
                            position: latLng,
                            map: map
                        });
                    });

                    // ê²½ë¡œ í‘œì‹œ
                    new kakao.maps.Polyline({
                        path: linePath,
                        strokeWeight: 5,
                        strokeColor: "#FF5733",
                        strokeOpacity: 0.8,
                        strokeStyle: "solid",
                        map: map
                    });

                    // ëª¨ë“  ë§ˆì»¤ê°€ ë³´ì´ë„ë¡ ì§€ë„ ì´ë™
                    map.setBounds(bounds);
                }
            }
        } else {
            mapContainer.style.display = "none";
        }
    }
</script>

</body>
</html>
