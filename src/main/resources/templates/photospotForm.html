<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Ï∂úÏÇ¨ÏßÄ Ïã†Ï≤≠</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <!-- Ïπ¥Ïπ¥Ïò§Îßµ SDK -->
    <script
            type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=dcc14e4ed8875f5829fe1274e43cee7b&libraries=services,drawing">
    </script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8fafc;
        }
        .map-container {
            height: 500px;
            width: 100%;
        }
        .result-list {
            max-height: 200px;
            overflow-y: auto;
            border-top: 1px solid #ddd;
            margin-top: 10px;
        }
        .result-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #ddd;
        }
        .result-item:hover {
            background-color: #f1f5f9;
        }
    </style>
</head>
<body>

<div th:replace="layout/navbar :: fragment"></div>

<!-- Î©îÏù∏ Ïª®ÌÖåÏù¥ÎÑà -->
<div class="max-w-6xl mx-auto p-6 bg-white shadow-lg rounded-lg mt-6">
    <h3 class="text-3xl font-bold text-gray-800 mb-6">üì∏ Ï∂úÏÇ¨ÏßÄ Ïã†Ï≤≠</h3>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

        <!-- ÏßÄÎèÑ -->
        <div class="p-4 bg-gray-100 rounded-lg">
            <div id="map" class="map-container rounded-lg shadow-md"></div>
            <div class="mt-3">
                <form onsubmit="searchPlaces(); return false;">
                    <div class="flex">
                        <input type="text" id="keyword"
                               class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                               placeholder="Ïû•ÏÜå Í≤ÄÏÉâ">
                        <button type="submit"
                                class="ml-2 px-4 py-3 h-full bg-blue-500 hover:bg-blue-600 text-white rounded-md whitespace-nowrap">
                            üîç Í≤ÄÏÉâ
                        </button>
                    </div>
                </form>
                <!-- Í≤ÄÏÉâ Í≤∞Í≥º Î¶¨Ïä§Ìä∏ -->
                <div id="search-results" class="result-list bg-white rounded-md shadow-md"></div>
                <!-- ÎêòÎèåÎ¶¨Í∏∞ Î≤ÑÌäº -->
                <button onclick="undoLastPoint()" class="mt-2 px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-md">
                    ‚è™ ÎßàÏßÄÎßâ Í≤ΩÎ°ú ÏÇ≠Ï†ú
                </button>
            </div>
        </div>

        <!-- Ïã†Ï≤≠ Ìèº -->
        <div class="p-6 bg-white rounded-lg shadow-md">
            <form id="description-form">
                <div class="mb-4">
                    <label for="title" class="block text-gray-700 font-medium">Ï∂úÏÇ¨ÏßÄ Ï†úÎ™©</label>
                    <input type="text" id="title" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>

                <div class="mb-4">
                    <label for="description" class="block text-gray-700 font-medium">Ï∂úÏÇ¨ÏßÄ ÏÑ§Î™Ö</label>
                    <textarea id="description" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                              rows="5"></textarea>
                </div>

                <div class="mb-4">
                    <label for="date" class="block text-gray-700 font-medium">Ï∂úÏÇ¨ ÎÇ†Ïßú</label>
                    <input type="date" id="date" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>

                <button type="submit" class="w-full px-4 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-md">
                    üìç Ï∂úÏÇ¨ÏßÄ Ïã†Ï≤≠
                </button>
            </form>
        </div>
    </div>
</div>

<script>
    // Ïπ¥Ïπ¥Ïò§Îßµ Ï¥àÍ∏∞Ìôî
    var mapContainer = document.getElementById('map');
    var mapOption = {
        center: new kakao.maps.LatLng(37.566826, 126.9786567), // Í∏∞Î≥∏ ÏÑúÏö∏ Ï§ëÏã¨Ï¢åÌëú
        level: 5
    };
    var map = new kakao.maps.Map(mapContainer, mapOption);
    var ps = new kakao.maps.services.Places();
    var infowindow = new kakao.maps.InfoWindow({zIndex: 1});

    var markers = [];         // ÌòÑÏû¨ ÏßÄÎèÑÏóê ÌëúÏãúÎêòÎäî ÎßàÏª§ Î∞∞Ïó¥
    var pathCoords = [];      // Í≤ΩÎ°úÎ°ú Íµ¨ÏÑ±Îê† Ï¢åÌëú Î∞∞Ïó¥
    var polyline = new kakao.maps.Polyline({
        map: map,
        path: pathCoords,
        strokeWeight: 5,
        strokeColor: '#FF5733',
        strokeOpacity: 0.8,
        strokeStyle: 'solid'
    });

    // ÏßÄÎèÑ ÌÅ¥Î¶≠ Ïãú Í≤ΩÎ°ú Ï∂îÍ∞Ä
    kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
        var latlng = mouseEvent.latLng;
        addPathPoint(latlng);
    });

    function searchPlaces() {
        var keyword = document.getElementById('keyword').value.trim();
        if (!keyword) {
            alert('ÌÇ§ÏõåÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
            return;
        }
        ps.keywordSearch(keyword, placesSearchCB);
    }

    function placesSearchCB(data, status) {
        if (status === kakao.maps.services.Status.OK) {
            displayPlaces(data);
        } else {
            alert('Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.');
        }
    }

    function displayPlaces(places) {
        var resultsContainer = document.getElementById('search-results');
        resultsContainer.innerHTML = "";

        places.forEach((place) => {
            var placePosition = new kakao.maps.LatLng(place.y, place.x);
            var item = document.createElement('div');
            item.className = "result-item";
            item.innerHTML = `<strong>${place.place_name}</strong><br>${place.address_name}`;
            item.onclick = function() {
                map.panTo(placePosition);
                infowindow.setContent(
                    `<div style="padding:5px;font-size:14px;">${place.place_name}</div>`
                );
                infowindow.open(
                    map,
                    new kakao.maps.Marker({ position: placePosition, map: map })
                );
                addPathPoint(placePosition);
            };
            resultsContainer.appendChild(item);
        });
    }

    function addPathPoint(position) {
        var marker = new kakao.maps.Marker({ position, map });
        markers.push(marker);
        pathCoords.push(position);
        polyline.setPath(pathCoords);
    }

    function undoLastPoint() {
        if (markers.length > 0) {
            markers.pop().setMap(null);
            pathCoords.pop();
            polyline.setPath(pathCoords);
        }
    }

    // Ìèº Ï†ÑÏÜ°
    document.getElementById('description-form').addEventListener('submit', function(e) {
        e.preventDefault();
        var title = document.getElementById('title').value.trim();
        var description = document.getElementById('description').value.trim();
        var date = document.getElementById('date').value;

        if (!title || !description || !date) {
            alert("Ï†úÎ™©, ÏÑ§Î™Ö, ÎÇ†ÏßúÎ•º Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!");
            return;
        }

        var pathList = pathCoords.map(coord => ({
            latitude: coord.getLat(),
            longitude: coord.getLng()
        }));

        fetch('/photospot/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, description, date, pathList })
        })
            .then(res => res.text())
            .then(data => {
                if (data === 'success') {
                    alert("Ï∂úÏÇ¨ÏßÄ Ïã†Ï≤≠ ÏôÑÎ£å!");
                    location.href = "/photospot/list";
                } else {
                    alert("ÏóêÎü¨Í∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.");
                }
            })
            .catch(err => console.error(err));
    });
</script>

</body>
</html>
