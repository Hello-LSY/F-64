<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4">
<head>
  <meta charset="UTF-8">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f8fafc;
    }
  </style>
  <title>ê²Œì‹œê¸€ ìƒì„¸ë³´ê¸°</title>
</head>
<body>

<div th:replace="layout/navbar :: fragment"></div>

<!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
<div class="max-w-4xl mx-auto bg-white shadow-lg rounded-lg p-6 mt-6">
  <h1 class="text-3xl font-bold text-gray-800 mb-4" th:text="${board.title}"></h1>

  <div class="flex items-center text-gray-500 text-sm mb-4">
    <span class="mr-4">ì‘ì„±ì: <span th:text="${board.writerNickname}"></span></span>
    <span class="mr-4">ì‘ì„±ì¼: <span th:text="${#temporals.format(board.createdDate, 'yyyy/MM/dd HH:mm')}"></span></span>
    <span class="mr-4">ì¡°íšŒìˆ˜: <span th:text="${board.viewCount}"></span></span>
    <span>ì¶”ì²œìˆ˜: <span id="likeCount" th:text="${board.likeCount}"></span></span>
  </div>

  <div class="border-t pt-4 text-gray-700" th:text="${board.content}"></div>

  <div class="mt-6">
    <img th:if="${board.filepath}" th:src="@{${board.filepath}}" alt="Board Image"
         class="rounded-lg shadow-md w-full max-h-96 object-cover">
  </div>

  <div class="mt-6 flex gap-4">
    <!-- ì¶”ì²œ ë²„íŠ¼ -->
    <button id="like-button" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-md flex items-center">
      ğŸ‘ ì¶”ì²œ (<span id="likeButtonCount" th:text="${board.likeCount}"></span>)
    </button>

    <form id="back" method="get" th:action="@{/board/list}">
      <button type="submit" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md">ğŸ“ƒ ëª©ë¡</button>
    </form>
    <form th:if="${isWriter}" id="update" method="get" th:action="@{/board/update/{id}(id=${board.id})}">
      <button type="submit" class="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-md">âœï¸ ìˆ˜ì •</button>
    </form>
    <form th:if="${isWriter}" id="delete" method="post"
          th:action="@{/board/delete/{id}(id=${board.id})}"
          onsubmit="return confirm('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">
      <button type="submit" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-md">ğŸ—‘ï¸ ì‚­ì œ</button>
    </form>
  </div>
</div>

<!-- ëŒ“ê¸€ ëª©ë¡ -->
<div class="max-w-4xl mx-auto mt-6">
  <h2 class="text-xl font-semibold text-gray-800 mb-4">ğŸ’¬ ëŒ“ê¸€</h2>
  <div id="comment-list" class="space-y-4">
    <div th:each="comment : ${commentList}" th:id="'comment-' + ${comment.id}" class="p-4 bg-gray-100 rounded-lg shadow-md">
      <div class="text-gray-600 text-sm">
        <span class="font-semibold text-gray-800" th:text="${comment.writerNickname}"></span>
        <span class="ml-2" th:text="${#temporals.format(comment.createdDate, 'yyyy/MM/dd HH:mm')}"></span>
      </div>
      <p class="text-gray-700 mt-2" th:text="${comment.content}"></p>

      <!-- í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìê°€ ëŒ“ê¸€ ì‘ì„±ìì™€ ë™ì¼í•  ê²½ìš° ì‚­ì œ ë²„íŠ¼ í‘œì‹œ -->
      <button th:if="${#authentication.name == comment.writerUsername}"
              th:attr="data-comment-id=${comment.id}"
              class="delete-comment-btn text-red-500 text-sm mt-2 hover:underline">ğŸ—‘ ì‚­ì œ</button>
    </div>
  </div>
</div>

<!-- ëŒ“ê¸€ ì…ë ¥ -->
<div class="max-w-4xl mx-auto mt-6 bg-white shadow-md rounded-lg p-6">
  <h2 class="text-lg font-semibold text-gray-800 mb-3">âœï¸ ëŒ“ê¸€ ì‘ì„±</h2>
  <form id="comment-form" method="post">
    <textarea id="comment-content" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
              rows="2" name="content" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
    <button type="submit" class="mt-3 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md">ğŸ’¬ ì‘ì„±í•˜ê¸°</button>
  </form>
</div>

<script>
  $(document).ready(function () {
    let boardId = [[${board.id}]];

    // ì¶”ì²œ ë²„íŠ¼ (AJAX ì ìš©)
    $("#like-button").click(function () {
      $.post("/board/like/" + boardId, function (data) {
        if (data.success) {
          $("#likeCount").text(data.likeCount);
          $("#likeButtonCount").text(data.likeCount);
          alert("ì¶”ì²œ ì™„ë£Œ!");
        } else {
          alert(data.message);
        }
      }).fail(function (xhr) {
        if (xhr.status === 401) {
          alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
          window.location.href = "/login";
        } else {
          alert("ì¶”ì²œ ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      });
    });

    // ëŒ“ê¸€ ì‘ì„± (AJAX ì ìš©)
    $("#comment-form").submit(function (event) {
      event.preventDefault();
      let content = $("#comment-content").val().trim();

      if (content === "") {
        alert("ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }

      $.post("/board/comment/" + boardId, { content: content }, function () {
        location.reload(); // ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ëŒ“ê¸€ ë°˜ì˜
      }).fail(function (xhr) {
        if (xhr.status === 401) {
          alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
          window.location.href = "/login";
        } else {
          alert("ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨");
        }
      });
    });

    // ëŒ“ê¸€ ì‚­ì œ (AJAX ì ìš©)
    $(".delete-comment-btn").click(function () {
      let commentId = $(this).attr("data-comment-id");

      if (!confirm("ì •ë§ë¡œ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

      $.post("/board/view/" + boardId + "/comment/delete/" + commentId, function () {
        $("#comment-" + commentId).remove();
        alert("ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
      }).fail(function (xhr) {
        if (xhr.status === 401) {
          alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
          window.location.href = "/login";
        } else {
          alert("ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨");
        }
      });
    });

  });
</script>

</body>
</html>
